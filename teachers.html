<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher Portal - Tyneceploh Educational Foundation</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #fff0f6;
    color: #4d0039;
    margin: 0; padding: 0;
    min-height: 100vh;
    display: flex; flex-direction: column;
  }
  header {
    background: #b35979;
    color: white;
    text-align: center;
    padding: 20px;
    font-size: 1.6rem;
    font-weight: bold;
    letter-spacing: 1px;
  }
  main {
    flex-grow: 1;
    max-width: 900px;
    margin: 20px auto;
    padding: 0 15px 30px 15px;
    background: #ffe6f0;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(179,89,121,0.3);
  }
  form {
    margin-top: 20px;
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  input[type="text"], input[type="password"], select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    border: 2px solid #b35979;
    border-radius: 5px;
    font-size: 1rem;
  }
  button {
    margin-top: 15px;
    padding: 10px 18px;
    background-color: #b35979;
    color: white;
    border: none;
    border-radius: 7px;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover {
    background-color: #7a2d4b;
  }
  .hidden {
    display: none;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
  }
  th, td {
    border: 1px solid #b35979;
    padding: 8px;
    text-align: center;
  }
  th {
    background-color: #b35979;
    color: white;
  }
  .grade-input {
    width: 60px;
  }
  .btn-small {
    padding: 6px 10px;
    font-size: 0.9rem;
    margin: 0 3px;
  }
  .red-grade {
    background-color: #f8d7da;
    color: #721c24;
    font-weight: bold;
  }
  .blue-grade {
    background-color: #d1ecf1;
    color: #0c5460;
    font-weight: bold;
  }
  #logout-btn {
    background-color: #662244;
    margin-top: 30px;
  }
  #logout-btn:hover {
    background-color: #400122;
  }
  .error {
    color: #900;
    margin-top: 5px;
    font-weight: bold;
  }
</style>
</head>
<body>

<header>Teacher Portal - Tyneceploh Educational Foundation</header>

<main>

<!-- Login Form -->
<section id="login-section">
  <h2>Teacher Login</h2>
  <form id="login-form">
    <label for="teacher-name">Name:</label>
    <input type="text" id="teacher-name" required />

    <label for="teacher-class">Class:</label>
    <input type="text" id="teacher-class" placeholder="e.g., Grade 5A" required />

    <label for="teacher-password">Password:</label>
    <input type="password" id="teacher-password" required />

    <button type="submit">Login</button>
  </form>
  <p id="login-error" class="error"></p>
</section>

<!-- Teacher Dashboard -->
<section id="dashboard-section" class="hidden">
  <h2>Welcome, <span id="teacher-welcome"></span></h2>

  <!-- Students & Subjects Table -->
  <button id="add-student-btn">Add Student</button>
  <table id="grades-table">
    <thead>
      <tr>
        <th>Student Name</th>
        <th>Subject</th>
        <th>Grade (60-100)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- dynamic rows here -->
    </tbody>
    <tfoot>
      <tr>
        <td colspan="2" style="text-align:right;"><strong>Average:</strong></td>
        <td id="average-cell" colspan="2">N/A</td>
      </tr>
    </tfoot>
  </table>

  <button id="add-subject-btn" class="btn-small">Add Subject</button>
  <button id="save-draft-btn" class="btn-small">Save as Draft</button>
  <button id="submit-report-btn" class="btn-small">Submit Report to Principal</button>
  <button id="logout-btn">Logout</button>
</section>

<!-- Add Student Modal -->
<div id="student-modal" class="hidden" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5); display:flex;justify-content:center;align-items:center;">
  <div style="background:#fff;padding:20px;border-radius:10px;min-width:300px;">
    <h3>Add Student</h3>
    <label for="new-student-name">Student Name:</label>
    <input type="text" id="new-student-name" />
    <div style="margin-top:15px;">
      <button id="save-student-btn">Add</button>
      <button id="cancel-student-btn">Cancel</button>
    </div>
  </div>
</div>

<script>
  // Sample teacher credentials and class (for demo/testing)
  const teachers = [
    {name: "Mr. Doe", class: "Grade 5A", password: "pass123"},
    {name: "Mrs. Smith", class: "Grade 6B", password: "abc456"}
  ];

  // State
  let loggedInTeacher = null;
  let students = []; // Array of {name: string}
  let subjects = []; // Array of strings
  let grades = {};   // Object keyed by studentName_subject: grade

  const loginSection = document.getElementById('login-section');
  const dashboardSection = document.getElementById('dashboard-section');
  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');
  const welcomeSpan = document.getElementById('teacher-welcome');
  const gradesTableBody = document.querySelector('#grades-table tbody');
  const averageCell = document.getElementById('average-cell');

  const addStudentBtn = document.getElementById('add-student-btn');
  const addSubjectBtn = document.getElementById('add-subject-btn');
  const saveDraftBtn = document.getElementById('save-draft-btn');
  const submitReportBtn = document.getElementById('submit-report-btn');
  const logoutBtn = document.getElementById('logout-btn');

  // Modal elements
  const studentModal = document.getElementById('student-modal');
  const newStudentNameInput = document.getElementById('new-student-name');
  const saveStudentBtn = document.getElementById('save-student-btn');
  const cancelStudentBtn = document.getElementById('cancel-student-btn');

  // Load draft if exists
  function loadDraft() {
    if (!loggedInTeacher) return;
    const key = `draft_${loggedInTeacher.name}_${loggedInTeacher.class}`;
    const draftStr = localStorage.getItem(key);
    if (draftStr) {
      const draft = JSON.parse(draftStr);
      students = draft.students || [];
      subjects = draft.subjects || [];
      grades = draft.grades || {};
    }
  }

  // Save draft to localStorage
  function saveDraft() {
    if (!loggedInTeacher) return;
    const key = `draft_${loggedInTeacher.name}_${loggedInTeacher.class}`;
    const draft = {students, subjects, grades};
    localStorage.setItem(key, JSON.stringify(draft));
    alert('Draft saved successfully!');
  }

  // Calculate averages per student and overall
  function calculateAverages() {
    let totalSum = 0, totalCount = 0;
    let studentAverages = {};

    students.forEach(student => {
      let sum = 0, count = 0;
      subjects.forEach(sub => {
        const gradeKey = student.name + '_' + sub;
        const grade = parseInt(grades[gradeKey]);
        if (!isNaN(grade)) {
          sum += grade;
          count++;
        }
      });
      if (count > 0) {
        studentAverages[student.name] = sum / count;
        totalSum += sum / count;
        totalCount++;
      } else {
        studentAverages[student.name] = null;
      }
    });

    const overallAvg = totalCount > 0 ? (totalSum / totalCount).toFixed(2) : 'N/A';
    return {studentAverages, overallAvg};
  }

  // Render grades table
  function renderGradesTable() {
    gradesTableBody.innerHTML = '';

    if (students.length === 0) {
      gradesTableBody.innerHTML = `<tr><td colspan="4">No students added yet.</td></tr>`;
      averageCell.textContent = 'N/A';
      return;
    }
    if (subjects.length === 0) {
      gradesTableBody.innerHTML = `<tr><td colspan="4">No subjects added yet.</td></tr>`;
      averageCell.textContent = 'N/A';
      return;
    }

    // Rows: each student-subject pair
    students.forEach(student => {
      subjects.forEach(subject => {
        const gradeKey = student.name + '_' + subject;
        const gradeVal = grades[gradeKey] || '';

        // Create row
        const tr = document.createElement('tr');

        // Student name cell (only in first subject row for that student)
        if (subjects.indexOf(subject) === 0) {
          const tdStudent = document.createElement('td');
          tdStudent.textContent = student.name;
          tdStudent.rowSpan = subjects.length;
          tdStudent.style.fontWeight = 'bold';
          tr.appendChild(tdStudent);
        }

        // Subject cell
        const tdSubj = document.createElement('td');
        tdSubj.textContent = subject;
        tr.appendChild(tdSubj);

        // Grade input cell
        const tdGrade = document.createElement('td');
        const inputGrade = document.createElement('input');
        inputGrade.type = 'number';
        inputGrade.min = 60;
        inputGrade.max = 100;
        inputGrade.className = 'grade-input';
        inputGrade.value = gradeVal;
        inputGrade.dataset.key = gradeKey;
        inputGrade.addEventListener('input', (e) => {
          const val = e.target.value;
          if(val === '' || (val >= 60 && val <= 100)) {
            grades[gradeKey] = val;
            e.target.classList.remove('red-grade', 'blue-grade');
            if(val !== '') {
              if(val < 70) e.target.classList.add('red-grade');
              else e.target.classList.add('blue-grade');
            }
            updateAverageDisplay();
          } else {
            e.target.value = '';
            delete grades[gradeKey];
            updateAverageDisplay();
          }
        });
        tdGrade.appendChild(inputGrade);
        tr.appendChild(tdGrade);

        // Actions cell (only on first subject row per student)
        if (subjects.indexOf(subject) === 0) {
          const tdActions = document.createElement('td');
          tdActions.rowSpan = subjects.length;

          // Remove student button
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Remove Student';
          removeBtn.className = 'btn-small';
          removeBtn.style.backgroundColor = '#900';
          removeBtn.style.color = 'white';
          removeBtn.addEventListener('click', () => {
            if (confirm(`Remove student ${student.name}?`)) {
              // Remove all grades related to this student
              subjects.forEach(sub => {
                delete grades[student.name + '_' + sub];
              });
              students = students.filter(s => s.name !== student.name);
              renderGradesTable();
              updateAverageDisplay();
            }
          });
          tdActions.appendChild(removeBtn);
          tr.appendChild(tdActions);
        }

        gradesTableBody.appendChild(tr);
      });
    });
    updateAverageDisplay();
  }

  // Update average display in footer
  function updateAverageDisplay() {
    const {studentAverages, overallAvg} = calculateAverages();

    // You can extend this if you want to display student averages elsewhere
    averageCell.textContent = overallAvg;
  }

  // Add new subject
  function addSubject() {
    const newSub = prompt('Enter new subject name:').trim();
    if(newSub && !subjects.includes(newSub)) {
      subjects.push(newSub);
      renderGradesTable();
    } else if(subjects.includes(newSub)) {
      alert('Subject already exists!');
    }
  }

  // Show add student modal
  function showAddStudentModal() {
    newStudentNameInput.value = '';
    studentModal.classList.remove('hidden');
    newStudentNameInput.focus();
  }
  // Hide add student modal
  function hideAddStudentModal() {
    studentModal.classList.add('hidden');
  }

  // Add new student from modal
  function addStudent() {
    const newName = newStudentNameInput.value.trim();
    if(newName === '') {
      alert('Student name cannot be empty!');
      return;
    }
    if(students.find(s => s.name === newName)) {
      alert('Student already exists!');
      return;
    }
    students.push({name: newName});
    renderGradesTable();
    hideAddStudentModal();
  }

  // Save draft handler
  saveDraftBtn.addEventListener('click', () => {
    saveDraft();
  });

  // Submit report handler
  submitReportBtn.addEventListener('click', () => {
    if (students.length === 0 || subjects.length === 0) {
      alert('Add students and subjects with grades before submitting.');
      return;
    }
    // Save submitted report to localStorage for principal
    const key = `submitted_report_${loggedInTeacher.name}_${loggedInTeacher.class}`;
    const report = {students, subjects, grades, submittedAt: new Date().toISOString()};
    localStorage.setItem(key, JSON.stringify(report));
    alert('Report submitted to principal successfully! Editing disabled.');

    // Disable inputs to prevent further editing after submission
    disableEditing();
  });

  // Disable all inputs (grades, add/remove buttons) after submission
  function disableEditing() {
    document.querySelectorAll('input.grade-input').forEach(input => input.disabled = true);
    addStudentBtn.disabled = true;
    addSubjectBtn.disabled = true;
    saveDraftBtn.disabled = true;
    submitReportBtn.disabled = true;
  }

  // Logout handler
  logoutBtn.addEventListener('click', () => {
    if(confirm('Are you sure you want to logout?')) {
      loggedInTeacher = null;
      students = [];
      subjects = [];
      grades = {};
      dashboardSection.classList.add('hidden');
      loginSection.classList.remove('hidden');
      loginError.textContent = '';
      loginForm.reset();
    }
  });

  // Login form submit
  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('teacher-name').value.trim();
    const cls = document.getElementById('teacher-class').value.trim();
    const pass = document.getElementById('teacher-password').value;

    const teacher = teachers.find(t => 
      t.name.toLowerCase() === name.toLowerCase() && 
      t.class.toLowerCase() === cls.toLowerCase() &&
      t.password === pass
    );

    if (teacher) {
      loggedInTeacher = teacher;
      loginSection.classList.add('hidden');
      dashboardSection.classList.remove('hidden');
      welcomeSpan.textContent = `${loggedInTeacher.name} (${loggedInTeacher.class})`;
      loadDraft();
      renderGradesTable();

      // Check if report already submitted - disable editing if yes
      const submittedKey = `submitted_report_${loggedInTeacher.name}_${loggedInTeacher.class}`;
      if(localStorage.getItem(submittedKey)) {
        alert('You have already submitted the report. Editing is disabled.');
        disableEditing();
      }
    } else {
      loginError.textContent = 'Invalid login information. Please try again.';
    }
  });

  // Button events
  addStudentBtn.addEventListener('click', showAddStudentModal);
  saveStudentBtn.addEventListener('click', addStudent);
  cancelStudentBtn.addEventListener('click', hideAddStudentModal);
  addSubjectBtn.addEventListener('click', addSubject);

</script>

</main>
</body>
</html>
