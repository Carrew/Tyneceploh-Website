<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher Portal - Tyneceploh</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #fff0f6;
    color: #4d0039;
    margin: 20px;
  }
  h1 {
    color: #b35979;
  }
  #welcome {
    margin-bottom: 15px;
    font-style: italic;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    max-width: 900px;
    margin-bottom: 20px;
  }
  th, td {
    border: 1px solid #b35979;
    padding: 8px;
    text-align: center;
  }
  th {
    background-color: #e6a8bb;
  }
  input[type=number] {
    width: 70px;
    font-size: 1rem;
    padding: 5px;
    text-align: center;
  }
  .red {
    background-color: #f8d7da;
    color: #721c24;
    font-weight: bold;
  }
  .blue {
    background-color: #d1ecf1;
    color: #0c5460;
    font-weight: bold;
  }
  button {
    background-color: #b35979;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 15px;
    cursor: pointer;
    font-weight: 700;
    margin-right: 10px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #99335c;
  }
  #controls {
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<h1>Teacher Portal - Tyneceploh Educational Foundation</h1>
<div id="welcome"></div>

<div id="controls">
  <button id="addSubjectBtn">Add Subject Column</button>
</div>

<table id="gradesTable">
  <thead>
    <tr id="subjectsRow">
      <th>Student Name</th>
      <th>Subject 1</th>
      <th>Average</th>
      <th>Rank</th>
      <th>Remove</th>
    </tr>
  </thead>
  <tbody id="gradesBody">
    <!-- Student rows go here -->
  </tbody>
</table>

<button id="saveBtn">Save Report</button>

<script>
  // Demo student list (you can load dynamically later)
  const students = [
    "Alice Johnson",
    "Bob Smith",
    "Cindy Lee",
    "David Kim",
    "Eva Brown"
  ];

  // On load, check if logged in teacher info is available
  const teacherName = sessionStorage.getItem('teacherName');
  const teacherClass = sessionStorage.getItem('teacherClass');
  const teacherPassword = sessionStorage.getItem('teacherPassword');

  const welcomeDiv = document.getElementById('welcome');
  const gradesBody = document.getElementById('gradesBody');
  const subjectsRow = document.getElementById('subjectsRow');
  const addSubjectBtn = document.getElementById('addSubjectBtn');
  const saveBtn = document.getElementById('saveBtn');

  if(!teacherName || !teacherClass || !teacherPassword) {
    alert('Not logged in. Redirecting to login page.');
    window.location.href = 'teacher-login.html';
  } else {
    welcomeDiv.textContent = `Welcome, ${teacherName} (Class: ${teacherClass})`;
  }

  // Track number of subjects (start with 1)
  let subjectCount = 1;

  // Initialize the table with students and inputs
  function createTable() {
    gradesBody.innerHTML = '';
    students.forEach((student, idx) => {
      const tr = document.createElement('tr');
      tr.dataset.studentIndex = idx;

      // Student Name
      const tdName = document.createElement('td');
      tdName.textContent = student;
      tr.appendChild(tdName);

      // Subject grades inputs (start with 1 subject)
      for(let i=0; i<subjectCount; i++) {
        const tdGrade = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'number';
        input.min = 60;
        input.max = 100;
        input.placeholder = '60-100';
        input.addEventListener('input', () => {
          validateInput(input);
          updateAverageAndRank();
        });
        tdGrade.appendChild(input);
        tr.appendChild(tdGrade);
      }

      // Average cell
      const tdAvg = document.createElement('td');
      tdAvg.textContent = '-';
      tr.appendChild(tdAvg);

      // Rank cell
      const tdRank = document.createElement('td');
      tdRank.textContent = '-';
      tr.appendChild(tdRank);

      // Remove row button
      const tdRemove = document.createElement('td');
      const btnRemove = document.createElement('button');
      btnRemove.textContent = 'Remove';
      btnRemove.style.backgroundColor = '#cc4452';
      btnRemove.addEventListener('click', () => {
        students.splice(idx, 1);
        createTable();
        updateAverageAndRank();
      });
      tdRemove.appendChild(btnRemove);
      tr.appendChild(tdRemove);

      gradesBody.appendChild(tr);
    });

    updateAverageAndRank();
  }

  // Validate grade input, restrict 60 to 100
  function validateInput(input) {
    let val = input.value;
    if(val === '') return;
    val = Number(val);
    if(val < 60) input.value = 60;
    else if(val > 100) input.value = 100;
  }

  // Update averages and ranks for all students
  function updateAverageAndRank() {
    const rows = [...gradesBody.querySelectorAll('tr')];

    // Calculate averages
    rows.forEach(tr => {
      const inputs = tr.querySelectorAll('td:nth-child(n+2):nth-child(-n+' + (1+subjectCount) + ') input');
      let sum = 0;
      let count = 0;
      inputs.forEach(input => {
        const val = Number(input.value);
        if(!isNaN(val) && val >= 60 && val <= 100) {
          sum += val;
          count++;
        }
      });
      const avg = count > 0 ? (sum / count).toFixed(2) : '-';
      const avgTd = tr.querySelector('td:nth-child(' + (2+subjectCount) + ')');
      avgTd.textContent = avg;

      // Color average cell blue or red based on passing mark 70
      if(avg !== '-') {
        avgTd.className = avg >= 70 ? 'blue' : 'red';
      } else {
        avgTd.className = '';
      }
    });

    // Sort students by average descending for ranking
    const validRows = rows.filter(tr => tr.querySelector('td:nth-child(' + (2+subjectCount) + ')').textContent !== '-');
    validRows.sort((a,b) => {
      return Number(b.querySelector('td:nth-child(' + (2+subjectCount) + ')').textContent) - 
             Number(a.querySelector('td:nth-child(' + (2+subjectCount) + ')').textContent);
    });

    // Assign ranks
    validRows.forEach((tr, i) => {
      const rankTd = tr.querySelector('td:nth-child(' + (3+subjectCount) + ')');
      rankTd.textContent = i + 1;
    });

    // For students without averages, clear ranks
    rows.filter(tr => !validRows.includes(tr)).forEach(tr => {
      const rankTd = tr.querySelector('td:nth-child(' + (3+subjectCount) + ')');
      rankTd.textContent = '-';
    });
  }

  // Add a subject column
  addSubjectBtn.addEventListener('click', () => {
    subjectCount++;
    // Add subject header
    const th = document.createElement('th');
    th.textContent = 'Subject ' + subjectCount;
    // Insert before average column
    subjectsRow.insertBefore(th, subjectsRow.children[subjectsRow.children.length - 3]);

    // Add a grade input for each student row
    const rows = [...gradesBody.querySelectorAll('tr')];
    rows.forEach(tr => {
      const tdGrade = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 60;
      input.max = 100;
      input.placeholder = '60-100';
      input.addEventListener('input', () => {
        validateInput(input);
        updateAverageAndRank();
      });
      tdGrade.appendChild(input);
      // Insert before average cell
      tr.insertBefore(tdGrade, tr.children[tr.children.length - 3]);
    });

    updateAverageAndRank();
  });

  // Save report (you can customize this to save to server or localStorage)
  saveBtn.addEventListener('click', () => {
    // Build a JSON object of student grades
    const rows = [...gradesBody.querySelectorAll('tr')];
    const report = [];

    rows.forEach(tr => {
      const studentName = tr.children[0].textContent;
      const grades = [];
      for(let i=1; i<=subjectCount; i++) {
        const val = tr.children[i].querySelector('input').value;
        grades.push(val === '' ? null : Number(val));
      }
      const avg = tr.children[1+subjectCount].textContent;
      const rank = tr.children[2+subjectCount].textContent;
      report.push({ studentName, grades, avg, rank });
    });

    // For now just show JSON in alert and also save to localStorage
    localStorage.setItem('teacherReport', JSON.stringify(report));
    alert('Report saved locally! You can expand this to submit to server.');
  });

  // Initialize table on page load
  createTable();
</script>

</body>
</html>
