<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher Portal - Tyneceploh</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #fff0f6;
    color: #4d0039;
    max-width: 900px;
    margin: 20px auto;
    padding: 0 20px 40px;
  }
  header {
    text-align: center;
    margin-bottom: 25px;
    font-size: 1.8rem;
    font-weight: bold;
    color: #b35979;
  }
  .teacher-info {
    margin-bottom: 30px;
    font-size: 1.1rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  table, th, td {
    border: 2px solid #b35979;
  }
  th, td {
    padding: 10px;
    text-align: center;
  }
  th {
    background-color: #e6a8bb;
  }
  .btn {
    background-color: #b35979;
    color: white;
    border: none;
    border-radius: 7px;
    padding: 8px 16px;
    cursor: pointer;
    margin-top: 10px;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }
  .btn:hover {
    background-color: #99335c;
  }
  .red {
    color: red;
    font-weight: bold;
  }
  .blue {
    color: blue;
    font-weight: bold;
  }
</style>
</head>
<body>

<header>Teacher Portal</header>

<div class="teacher-info" id="teacherInfo"></div>

<div>
  <button class="btn" id="addSubjectBtn">Add Subject</button>
</div>

<form id="gradesForm">
  <div id="subjectsContainer">
    <!-- Subject tables will be added here dynamically -->
  </div>

  <button type="submit" class="btn">Create Report</button>
</form>

<script>
  // On load: read teacher info from sessionStorage
  const teacherName = sessionStorage.getItem('teacherName');
  const teacherClass = sessionStorage.getItem('teacherClass');

  if (!teacherName || !teacherClass) {
    alert('You must login first!');
    window.location.href = 'teacher-login.html';
  } else {
    document.getElementById('teacherInfo').textContent = `Welcome, ${teacherName} - Class: ${teacherClass}`;
  }

  const subjectsContainer = document.getElementById('subjectsContainer');
  const addSubjectBtn = document.getElementById('addSubjectBtn');

  // Function to create a subject input table
  function createSubjectTable(subjectIndex) {
    const table = document.createElement('table');
    table.dataset.subjectIndex = subjectIndex;

    table.innerHTML = `
      <thead>
        <tr>
          <th colspan="3">
            Subject <input type="text" name="subjectName${subjectIndex}" placeholder="Enter subject name" required />
            <button type="button" class="btn removeSubjectBtn" style="background:#cc4444; float:right;">Remove</button>
          </th>
        </tr>
        <tr>
          <th>Student Name</th>
          <th>Grade (60-100)</th>
          <th>Remarks</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text" name="studentName${subjectIndex}[]" placeholder="Student name" required /></td>
          <td><input type="number" name="studentGrade${subjectIndex}[]" min="60" max="100" required /></td>
          <td class="remarks"></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3">
            <button type="button" class="btn addStudentBtn">Add Student</button>
          </td>
        </tr>
      </tfoot>
    `;

    // Add listeners for Add Student and Remove Subject buttons
    table.querySelector('.addStudentBtn').addEventListener('click', () => {
      const tbody = table.querySelector('tbody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" name="studentName${subjectIndex}[]" placeholder="Student name" required /></td>
        <td><input type="number" name="studentGrade${subjectIndex}[]" min="60" max="100" required /></td>
        <td class="remarks"></td>
      `;
      tbody.appendChild(newRow);
    });

    table.querySelector('.removeSubjectBtn').addEventListener('click', () => {
      subjectsContainer.removeChild(table);
      updateSubjectIndexes();
    });

    return table;
  }

  // Add new subject table on click
  let subjectCount = 0;
  addSubjectBtn.addEventListener('click', () => {
    subjectCount++;
    const table = createSubjectTable(subjectCount);
    subjectsContainer.appendChild(table);
  });

  // Update subject indexes to keep input names consistent after removal
  function updateSubjectIndexes() {
    const tables = subjectsContainer.querySelectorAll('table');
    tables.forEach((table, idx) => {
      const newIndex = idx + 1;
      table.dataset.subjectIndex = newIndex;
      // Update subject input name and label
      const subjectInput = table.querySelector(`input[name^="subjectName"]`);
      subjectInput.name = `subjectName${newIndex}`;
      table.querySelector('th input').parentElement.textContent = `Subject `;
      table.querySelector('th').appendChild(subjectInput);
      const removeBtn = table.querySelector('.removeSubjectBtn');
      removeBtn.style.cssText = 'background:#cc4444; float:right;';
      table.querySelector('th').appendChild(removeBtn);

      // Update student inputs names
      table.querySelectorAll('tbody tr').forEach(row => {
        const studentNameInput = row.querySelector(`input[name^="studentName"]`);
        const studentGradeInput = row.querySelector(`input[name^="studentGrade"]`);
        if(studentNameInput) studentNameInput.name = `studentName${newIndex}[]`;
        if(studentGradeInput) studentGradeInput.name = `studentGrade${newIndex}[]`;
      });
    });
    subjectCount = tables.length;
  }

  // Handle form submission to create report
  document.getElementById('gradesForm').addEventListener('submit', e => {
    e.preventDefault();

    // Gather all students and grades across subjects, calculate averages, and rank students

    let allStudents = {}; // { studentName: { totalGrade: 0, count: 0 } }

    const tables = subjectsContainer.querySelectorAll('table');
    if(tables.length === 0) {
      alert('Add at least one subject with student grades.');
      return;
    }

    tables.forEach(table => {
      const subjectIndex = table.dataset.subjectIndex;
      const subjectName = table.querySelector(`input[name="subjectName${subjectIndex}"]`).value.trim();

      if(!subjectName) {
        alert('Please enter all subject names.');
        throw new Error('Subject name missing');
      }

      const studentNames = Array.from(table.querySelectorAll(`input[name="studentName${subjectIndex}[]"]`)).map(input => input.value.trim());
      const studentGrades = Array.from(table.querySelectorAll(`input[name="studentGrade${subjectIndex}[]"]`)).map(input => Number(input.value));

      for(let i=0; i<studentNames.length; i++) {
        const name = studentNames[i];
        const grade = studentGrades[i];

        if(!name) {
          alert('Student names cannot be empty');
          throw new Error('Empty student name');
        }
        if(isNaN(grade) || grade < 60 || grade > 100) {
          alert('Grades must be between 60 and 100');
          throw new Error('Invalid grade');
        }

        if(!allStudents[name]) {
          allStudents[name] = { totalGrade: 0, count: 0 };
        }
        allStudents[name].totalGrade += grade;
        allStudents[name].count++;
      }
    });

    // Calculate averages
    let results = [];
    for (const [student, data] of Object.entries(allStudents)) {
      const avg = data.totalGrade / data.count;
      results.push({ student, average: avg });
    }

    // Sort by average descending
    results.sort((a, b) => b.average - a.average);

    // Assign ranks (ties get same rank)
    let rank = 1;
    results.forEach((r, i) => {
      if(i > 0 && r.average < results[i-1].average) rank = i + 1;
      r.rank = rank;
    });

    // Build report table
    let reportWindow = window.open('', 'Report', 'width=700,height=600');
    reportWindow.document.write('<html><head><title>Report Card</title><style>');
    reportWindow.document.write(`
      body { font-family: Arial, sans-serif; padding: 20px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 2px solid #b35979; padding: 10px; text-align: center; }
      th { background-color: #e6a8bb; }
      .red { color: red; font-weight: bold; }
      .blue { color: blue; font-weight: bold; }
    `);
    reportWindow.document.write('</style></head><body>');
    reportWindow.document.write('<h2>Report Card - Class: ' + teacherClass + '</h2>');
    reportWindow.document.write('<table><thead><tr><th>Rank</th><th>Student Name</th><th>Average Grade</th></tr></thead><tbody>');

    results.forEach(r => {
      const colorClass = r.average >= 70 ? 'blue' : 'red';
      reportWindow.document.write(`<tr><td>${r.rank}</td><td>${r.student}</td><td class="${colorClass}">${r.average.toFixed(2)}</td></tr>`);
    });

    reportWindow.document.write('</tbody></table>');
    reportWindow.document.write('</body></html>');
    reportWindow.document.close();
  });
</script>

</body>
</html>
